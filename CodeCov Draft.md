# CodeCov Integration Guide

This guide will walk you through setting up CodeCov to track your test coverage and generate reports using a GitHub Action pipeline. It will make use of a forked [Django](https://www.djangoproject.com/) web framework [repository](https://github.com/django/django) as an example, simply adjusting these steps to will allow you to add CodeCov integration with any other application that already generates code coverage reports.

## Why Use CodeCov?

CodeCov is a powerful tool for visualizing code coverage and helping developers track the effectiveness of their tests. By integrating it into your CI/CD pipeline, you can ensure continuous monitoring of code coverage metrics across branches and pull requests, encouraging higher code quality.

## Prerequisites

* A GitHub account
* Fork of the Django [repository](https://github.com/django/django) or another existing application repository
* A CodeCove account, create a free trial account [here](https://about.codecov.io/codecov-free-trial/)

---

## Setting Up CodeCov

1. **Create a CodeCov Account**:
Sign up for a CodeCov account by following the official [quick start guide](https://docs.codecov.com/docs/quick-start). CodeCov integrates with platforms like GitHub, Bitbucket, and GitLab, allowing seamless integration into your development workflow.

2. **Get Your CodeCov Upload Token**:
Once you’ve created an account and connected your repository, obtain the unique upload token for your project. You’ll need this token to securely upload coverage reports to CodeCov.

3. **Install the GitHub Application**:
If you’re using GitHub, install the CodeCov GitHub [application](https://github.com/apps/codecov) and provide access to the repository you would like to manage. This will allow CodeCov to access your repository and provide automatic reporting on pull requests.

---

## Generating a Coverage Report Locally

Once CodeCov is set up, the next step is to generate a coverage report locally to ensure everything works before automating it via GitHub Actions.

In a terminal, clone the forked Django repo:

```bash
git clone https://github.com/<YourGitHubName>/django.git django-repo
```

Navigate into the newly cloned repository:

```bash
cd django-repo
```

### Install Python Packages

If you’re following along using the Django project, ensure your packages are installed locally by running:

```bash
python -m pip install -e .
```

### Install Required Testing Dependencies

Install the test dependencies with:

```bash
python -m pip install -r tests/requirements/py3.txt
```

### Install Coverage

Additionally, install the `coverage` package, which will generate the coverage reports:

```bash
python -m pip install coverage
```

### Run Tests with Coverage

Run the test suite. Adjust the paths as necessary to fit your project’s structure:

```bash
coverage run ./tests/runtests.py --settings=test_sqlite
```

### Combine Coverage Data (if needed)

If you have multiple coverage reports (from different test runs), combine them into a single report:

```bash
coverage combine
```

### Generate an XML Coverage Report

CodeCov requires an XML-format coverage report. Generate it by running:

```bash
coverage xml
```

This is the point at which you would usually stop to inspect the coverage report that was generated by opening the `coverage.xml` file.

If you view the content of `coverage.xml`:

```bash
cat coverage.xml
```

## Upload the Coverage Report to CodeCov

Now, upload the coverage report using CodeCov’s GitHub Action. Add this step to your GitHub Actions workflow:

```yaml
- name: Upload results to Codecov
    uses: codecov/codecov-action@v4
    with:
        token: ${{ secrets.CODECOV_TOKEN }}
```

This step makes use of the CodeCov GitHub application to collect the coverage report and upload it to CodeCov so that it can be processed and the visualizations and reports generated.

### View the Coverage Report on CodeCov

Once the upload is successful, navigate to your CodeCov dashboard to view and analyze the coverage report in detail.

---

## Running CodeCov in a GitHub Action

To automate coverage tracking, you’ll want to run CodeCov as part of your CI pipeline using GitHub Actions.

### Create a GitHub Actions Workflow

Add a new workflow configuration file at `.github/workflows/ci.yml` in your repository. This file will define the steps for running tests, generating coverage reports, and uploading them to CodeCov.

### Define the Workflow

Below is a sample configuration for running tests and uploading coverage reports using CodeCov:

```yaml
name: Continuous Integration (CI)

on: [push, pull_request]

jobs:
build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
        uses: actions/checkout@v2

    - name: Set up Python
        uses: actions/setup-python@v2
        with:
        python-version: '3.x'

    - name: Install dependencies
        run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov coverage

    - name: Run tests and generate coverage report
        run: |
        coverage run ./tests/runtests.py --settings=test_sqlite
        coverage combine
        coverage xml

    - name: Upload coverage report to Codecov
        uses: codecov/codecov-action@v4
        with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
```

### Commit and Push Your Changes

After creating the workflow file, commit and push your changes to trigger the workflow:

 ```bash
 git add .
 git commit -m "Add CodeCov integration"
 git push origin main
 ```

### Monitor the GitHub Actions Pipeline

Open the **Actions** tab in your GitHub repository to monitor the status of the CI pipeline. Make sure that all steps, especially the CodeCov upload, complete successfully.

### Verify Coverage Upload

After the pipeline completes, check the CodeCov dashboard to verify that the coverage report was uploaded correctly.

---

## Additional Notes

- **CodeCov VSCode Extension**: If you’re using VSCode, the CodeCov extension is mainly for YAML validation and doesn’t provide any advanced functionality for coverage management.
  
- **CLI vs. GitHub Actions**: While both the CodeCov CLI and GitHub Actions perform similar tasks, they may behave slightly differently. Ensure consistency by testing both locally and in the CI environment.

By following this guide, you’ll have CodeCov fully integrated into your development process, helping maintain high code quality through continuous monitoring of test coverage.
